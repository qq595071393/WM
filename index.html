<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>LiLi影子跟读完美版 - 专业语言学习工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --dark: #1d3557;
            --light: #f1faee;
            --success: #2ec4b6;
            --warning: #ff9f1c;
            --danger: #e63946;
            --text: #333;
            --subtitle-eng: #FFD700 !important;
            --subtitle-chi: #FFFFFF !important;
            --subtitle-size-base: 1.6rem;
            --subtitle-size-eng: 1.8rem;
            --subtitle-size-chi: 1.0rem;
        }

        #wordTooltip {
            display: none;
            position: fixed;
            background: rgba(29, 53, 87, 0.95);
            border: 2px solid #4cc9f0;
            border-radius: 12px;
            padding: 15px;
            max-width: 300px;
            z-index: 99999;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-family: 'Noto Sans SC', sans-serif;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        #wordTooltip .word-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        #tooltipWord {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        #tooltipPhonetic {
            margin-left: 12px;
            color: var(--warning);
            font-size: 1.1rem;
        }
        
        #tooltipDefinition {
            font-size: 1.1rem;
            line-height: 1.5;
            margin: 15px 0;
        }
        
        #tooltipTags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .word-tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            background: var(--primary);
        }
        
        .word-tag.cet4 {
            background: linear-gradient(to right, #4361ee, #3f37c9);
        }
        
        .word-tag.cet6 {
            background: linear-gradient(to right, #7209b7, #560bad);
        }
        
        .word-tag.ielts {
            background: linear-gradient(to right, #e63946, #d00000);
        }
        
        .word-tag.postgraduate {
            background: linear-gradient(to right, #2ec4b6, #1a936f);
        }
        
        .word {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 3px;
            position: relative;
            user-select: none;
        }
        
        .word:hover {
            background: rgba(76, 201, 240, 0.4);
            transform: translateY(-1px);
            text-shadow: 0 0 8px rgba(76, 201, 240, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .word:active {
            transform: translateY(0px);
            background: rgba(76, 201, 240, 0.6);
        }
        
        #wordDbStatus {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(29, 53, 87, 0.9);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--light);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        .subtitle-container {
            pointer-events: auto !important;
        }
        
        .subtitle-container * {
            pointer-events: auto !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2a3c6c, #3a4c6c);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-attachment: fixed;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(29, 53, 87, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin: 20px auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            padding: 20px;
            text-align: center;
            position: relative;
            border-bottom: 3px solid var(--accent);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            position: relative;
        }

        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        .main-content {
            padding: 25px;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
        }
        
        /* 确保字幕容器完全在视频区域内 */
        .video-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            pointer-events: none;
            z-index: 5;
        }

        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            border: none;
        }

        .subtitle-container {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            padding: 0 15px;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
            max-height: 35%;
            overflow: visible;
            box-sizing: border-box;
        }

        .subtitle {
            font-size: var(--subtitle-size-base);
            font-weight: 700;
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000,
                0 0 3px rgba(0, 0, 0, 0.8);
            line-height: 1.3;
            margin: 1px 0;
            padding: 3px 8px;
            display: block;
            border-radius: 4px;
            background: transparent;
            transition: all 0.3s ease;
            width: auto;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-height: none;
            overflow: visible;
            white-space: normal;
            text-overflow: clip;
            hyphens: auto;
            -webkit-hyphens: auto;
            -moz-hyphens: auto;
            cursor: pointer;
            box-sizing: border-box;
            text-align: center;
        }
        
        /* 移动端长文本处理 */
        @media (max-width: 768px) {
            .subtitle-container {
                bottom: 8px !important;
                padding: 0 10px !important;
                max-height: 25% !important;
                overflow: visible !important;
                gap: 1px !important;
            }
            
            .subtitle {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                padding: 1px 6px !important;
                line-height: 1.1 !important;
                margin: 0.5px 0 !important;
            }
            
            /* 英文字幕(蓝色)允许换行但尽量保持连贯 */
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 88% !important;
                font-size: 1.3rem !important;
                order: 1 !important;
            }
            
            /* 中文字幕(黄色)允许自由换行 */
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.75rem !important;
                order: 2 !important;
            }
        }

        .english {
            color: var(--subtitle-eng);
            font-size: var(--subtitle-size-eng);
            order: 1 !important;
            flex-shrink: 0;
        }

        .chinese {
            color: var(--subtitle-chi);
            font-size: calc(var(--subtitle-size-chi) + 2px);
            order: 2 !important;
            flex-shrink: 0;
        }

        .controls {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .primary-controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 20px;
        }

        .secondary-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 50px;
        }

        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-large {
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
        }

        .toggle-btn {
            background: rgba(67, 97, 238, 0.2);
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .toggle-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .counter {
            font-size: 1.2rem;
            font-weight: 700;
            background: var(--success);
            color: white;
            border-radius: 20px;
            padding: 8px 15px;
            min-width: 100px;
            text-align: center;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-btn:hover {
            background: rgba(76, 201, 240, 0.3);
        }

        .speed-btn.active {
            background: var(--accent);
            color: var(--dark);
            font-weight: 700;
        }

        .mobile-speed-btn {
            display: none;
            background: rgba(67, 97, 238, 0.2);
            color: var(--accent);
            border: 2px solid var(--accent);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .mobile-speed-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
        }

        .mobile-speed-btn.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .speed-popup {
            position: fixed;
            background: rgba(29, 53, 87, 0.95);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 0;
            max-width: 300px;
            min-width: 250px;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--light);
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .speed-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .speed-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px 0 20px;
            border-bottom: 1px solid rgba(76, 201, 240, 0.3);
        }

        .speed-popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .speed-popup-close {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .speed-popup-close:hover {
            background: rgba(230, 57, 70, 0.3);
            color: var(--danger);
        }

        .speed-popup-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .speed-popup-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
        }

        .speed-popup-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            border-color: var(--accent);
        }

        .speed-popup-btn.active {
            background: var(--accent);
            color: var(--dark);
            font-weight: 700;
            border-color: var(--accent);
        }

        .file-upload {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .upload-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .upload-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 2px solid var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .upload-btn:hover {
            background: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--warning);
            min-height: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .status.error {
            color: var(--danger);
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid rgba(230, 57, 70, 0.3);
        }
        
        .status.success {
            color: var(--success);
            background: rgba(46, 196, 182, 0.1);
            border: 1px solid rgba(46, 196, 182, 0.3);
        }
        
        .status.info {
            color: var(--accent);
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--accent));
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* 响应式设计 - 大屏幕 */
        @media (min-width: 1200px) {
            :root {
                --subtitle-size-base: 1.4rem;
                --subtitle-size-eng: 1.9rem;
                --subtitle-size-chi: 1.1rem;
            }
            
            .english {
                font-size: 1.9rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(1.1rem + 2px) !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 85%;
            }
        }

        @media (max-width: 1199px) and (min-width: 769px) {
            :root {
                --subtitle-size-base: 1.3rem;
                --subtitle-size-eng: 1.7rem;
                --subtitle-size-chi: 1.0rem;
            }
            
            .english {
                font-size: 1.7rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(1.0rem + 2px) !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 82%;
            }
        }

        @media (max-width: 768px) {
            :root {
                --subtitle-size-base: 1.0rem;
                --subtitle-size-eng: 1.4rem;
                --subtitle-size-chi: 0.8rem;
            }
            
            .english {
                font-size: 1.4rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: calc(0.8rem + 1px) !important;
                order: 2 !important;
            }
            
            .container {
                margin: 10px;
            }
            
            .primary-controls {
                gap: 15px;
            }
            
            .secondary-controls {
                gap: 10px;
            }
            
            .btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .btn-large {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .subtitle {
                max-width: 90%;
                padding: 1px 6px;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                line-height: 1.1;
                word-break: break-word;
                overflow-wrap: break-word;
                display: inline-block;
                text-align: center;
            }
            
            .english {
                font-size: 1.3rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.75rem !important;
                order: 2 !important;
            }
            
            .control-group {
                padding: 8px 15px;
            }
            
            .counter {
                font-size: 1rem;
                min-width: 80px;
                padding: 6px 10px;
            }
            
            .speed-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            #wordTooltip {
                max-width: 250px;
                padding: 12px;
            }
            
            #tooltipWord {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            :root {
                --subtitle-size-base: 0.85rem;
                --subtitle-size-eng: 1.15rem;
                --subtitle-size-chi: 0.7rem;
            }
            
            .english {
                font-size: 1.15rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.7rem !important;
                order: 2 !important;
            }
            
            .speed-control {
                display: none;
            }
            
            .mobile-speed-btn {
                display: flex !important;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .primary-controls {
                gap: 8px;
            }
            
            .btn {
                width: 45px;
                height: 45px;
            }
            
            .btn-large {
                width: 55px;
                height: 55px;
            }
            
            .subtitle {
                max-width: 90%;
                padding: 1px 6px;
                line-height: 1.05;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                word-break: break-word;
                overflow-wrap: break-word;
                display: block;
                text-align: center;
                margin: 0.5px 0;
                text-shadow: 
                    -1px -1px 0 #000,  
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000,
                    0 0 2px rgba(0, 0, 0, 0.8);
            }
            
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.65rem !important;
                order: 2 !important;
            }
            
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 88% !important;
                font-size: 1.05rem !important;
                order: 1 !important;
            }
            
            .subtitle-container {
                bottom: 8px !important;
                left: 0 !important;
                right: 0 !important;
                padding: 0 8px !important;
                gap: 0.5px !important;
                max-height: 25% !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
            
            .upload-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            #wordTooltip {
                max-width: 220px;
                padding: 10px;
                font-size: 0.9rem;
            }
            
            #tooltipWord {
                font-size: 1.1rem;
            }
            
            #tooltipDefinition {
                font-size: 0.9rem;
            }
            
            .word-tag {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }

        @media (max-width: 360px) {
            :root {
                --subtitle-size-base: 0.75rem;
                --subtitle-size-eng: 1.0rem;
                --subtitle-size-chi: 0.6rem;
            }
            
            .english {
                font-size: 1.0rem !important;
                order: 1 !important;
            }
            
            .chinese {
                font-size: 0.6rem !important;
                order: 2 !important;
            }
            
            .subtitle {
                max-width: 92%;
                padding: 1px 5px;
                line-height: 1.0;
                max-height: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                word-break: break-word;
                overflow-wrap: break-word;
                display: block;
                text-align: center;
                margin: 0.5px 0;
                hyphens: auto;
                text-shadow: 
                    -1px -1px 0 #000,  
                    1px -1px 0 #000,
                    -1px 1px 0 #000,
                    1px 1px 0 #000,
                    0 0 2px rgba(0, 0, 0, 0.8);
            }
            
            .subtitle.chinese {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 92% !important;
                font-size: 0.55rem !important;
                order: 2 !important;
            }
            
            .subtitle.english {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 90% !important;
                font-size: 0.9rem !important;
                order: 1 !important;
            }
            
            .subtitle-container {
                bottom: 6px !important;
                left: 0 !important;
                right: 0 !important;
                gap: 0.5px !important;
                padding: 0 6px !important;
                max-height: 25% !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .btn-active {
            animation: pulse 0.5s ease;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #2a3c6c, #3a4c6c);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-family: 'Roboto', sans-serif;
        }
        
        .page-loading.hidden {
            display: none;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="page-loading" id="pageLoading">
        <div class="loading"></div>
        <div class="loading-text">LiLi影子跟读完美版 正在加载...</div>
    </div>
    
    <div id="wordTooltip">
        <div class="word-header">
            <div id="tooltipWord">Word</div>
            <div id="tooltipPhonetic">/prəˌnʌnsiˈeɪʃən/</div>
        </div>
        <div id="tooltipDefinition">Definition will appear here.</div>
        <div id="tooltipTags"></div>
    </div>
    
    <div id="wordDbStatus">
        <span class="loading"></span> 加载单词数据库中...
    </div>
    
    <div class="speed-popup" id="speedPopup">
        <div class="speed-popup-header">
            <div class="speed-popup-title">选择播放速度</div>
            <button class="speed-popup-close" id="speedPopupClose">&times;</button>
        </div>
        <div class="speed-popup-content">
            <button class="speed-popup-btn" data-speed="0.25">0.25x</button>
            <button class="speed-popup-btn" data-speed="0.5">0.5x</button>
            <button class="speed-popup-btn" data-speed="0.75">0.75x</button>
            <button class="speed-popup-btn active" data-speed="1">1x</button>
            <button class="speed-popup-btn" data-speed="1.25">1.25x</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>LiLi影子跟读完美版</h1>
            <div class="tagline">专业级语言学习工具 - 提升口语流利度</div>
        </header>
        
        <div class="main-content">
            <div class="video-container">
                <video class="video-player" id="videoPlayer" playsinline>
                    您的浏览器不支持视频播放
                </video>
                
                <div class="subtitle-container" id="subtitleContainer">
                    <div class="subtitle english" id="englishSub" style="order: 1 !important;"></div>
                    <div class="subtitle chinese" id="chineseSub" style="order: 2 !important;"></div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="controls">
                <div class="primary-controls">
                    <button class="btn" id="prevBtn" title="上一句">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="btn btn-large" id="playPauseBtn" title="播放/暂停">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn" id="nextBtn" title="下一句">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="secondary-controls">
                    <div class="control-group">
                        <button class="btn toggle-btn" id="loopBtn" title="单句循环">
                            <i class="fas fa-repeat"></i>
                        </button>
                        <div class="counter" id="loopCounter">循环: 0</div>
                    </div>
                    
                    <div class="control-group">
                        <button class="btn toggle-btn" id="subtitleBtn" title="字幕开关">
                            <i class="fas fa-closed-captioning"></i>
                        </button>
                        <div>字幕</div>
                    </div>
                    
                    <div class="control-group">
                        <div>倍速:</div>
                        <div class="speed-control">
                            <button class="speed-btn" data-speed="0.25">0.25x</button>
                            <button class="speed-btn" data-speed="0.5">0.5x</button>
                            <button class="speed-btn" data-speed="0.75">0.75x</button>
                            <button class="speed-btn active" data-speed="1">1x</button>
                            <button class="speed-btn" data-speed="1.25">1.25x</button>
                        </div>
                        <button class="mobile-speed-btn" id="mobileSpeedBtn" title="选择倍速">
                            <i class="fas fa-tachometer-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="file-upload">
                <div class="upload-title">上传学习材料</div>
                <div class="upload-options">
                    <div class="upload-btn" id="videoUploadBtn">
                        <i class="fas fa-video"></i> 上传视频
                        <input type="file" class="file-input" id="videoUpload" accept="video/*,.mp4,.avi,.mov,.wmv,.flv,.webm,.m4v,.3gp">
                    </div>
                    <div class="upload-btn" id="subtitleUploadBtn">
                        <i class="fas fa-closed-captioning"></i> 上传字幕
                        <input type="file" class="file-input" id="subtitleUpload" accept="*/*">
                    </div>
                </div>
                
                <div class="preview-container">
                    <div class="preview-title">已上传文件</div>
                    <div class="preview-filename" id="videoFilename">未选择视频文件</div>
                    <div class="preview-filename" id="subtitleFilename">未选择字幕文件</div>
                </div>
                
                <div class="status" id="statusMessage">请上传视频和字幕文件开始学习</div>
            </div>
        </div>
    </div>

    <script>
        // 单词数据库（包含更多单词）
        let wordDatabase = {};
        
        // 字幕数据（移到全局作用域，以便initWordDatabase函数访问）
        let subtitles = [];
        
        // 初始化单词数据库
        function initWordDatabase() {
            console.log('正在初始化单词数据库...');
            const wordDbStatus = document.getElementById('wordDbStatus');
            
            // 检测当前运行环境
            const isFileProtocol = window.location.protocol === 'file:';
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isGitHubPages = window.location.hostname.includes('github.io');
            
            console.log('运行环境检测:', {
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                isFileProtocol: isFileProtocol,
                isLocalhost: isLocalhost,
                isGitHubPages: isGitHubPages
            });
            
            // 如果使用file://协议，尝试使用备用方案
            if (isFileProtocol) {
                console.log('检测到file://协议，使用备用方案');
                wordDbStatus.innerHTML = '<i class="fas fa-info-circle" style="color: #4cc9f0;"></i> 本地文件模式：单词查询功能受限';
                
                // 使用内置的基础单词数据库
                wordDatabase = {
                    "shadowing": {
                        phonetic: "/ˈʃædoʊɪŋ/",
                        definition: "n. 跟读法；影子练习",
                        tags: ["ielts"]
                    },
                    "academic": {
                        phonetic: "/ˌækəˈdemɪk/",
                        definition: "adj. 学术的；教学的；理论的",
                        tags: ["cet6", "postgraduate"]
                    },
                    "pronunciation": {
                        phonetic: "/prəˌnʌnsiˈeɪʃən/",
                        definition: "n. 发音；读音",
                        tags: ["cet4", "ielts"]
                    },
                    "fluency": {
                        phonetic: "/ˈfluːənsi/",
                        definition: "n. 流利；流畅",
                        tags: ["cet6", "ielts"]
                    },
                    "vocabulary": {
                        phonetic: "/vəˈkæbjələri/",
                        definition: "n. 词汇；词汇量",
                        tags: ["cet4", "ielts"]
                    },
                    "grammar": {
                        phonetic: "/ˈɡræmə(r)/",
                        definition: "n. 语法；文法",
                        tags: ["cet4", "ielts"]
                    },
                    "listening": {
                        phonetic: "/ˈlɪsnɪŋ/",
                        definition: "n. 听力；听",
                        tags: ["cet4", "ielts"]
                    },
                    "speaking": {
                        phonetic: "/ˈspiːkɪŋ/",
                        definition: "n. 口语；说话",
                        tags: ["cet4", "ielts"]
                    },
                    "reading": {
                        phonetic: "/ˈriːdɪŋ/",
                        definition: "n. 阅读；朗读",
                        tags: ["cet4", "ielts"]
                    },
                    "writing": {
                        phonetic: "/ˈraɪtɪŋ/",
                        definition: "n. 写作；书写",
                        tags: ["cet4", "ielts"]
                    }
                };
                
                console.log('使用内置单词数据库，包含 ' + Object.keys(wordDatabase).length + ' 个单词');
                wordDbStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #2ec4b6;"></i> 内置单词数据库已加载 (' + Object.keys(wordDatabase).length + ' 个单词)';
                
                // 在单词数据库加载完成后，重新调用updateSubtitles（如果字幕已经加载）
                if (subtitles && subtitles.length > 0) {
                    console.log('重新更新字幕以应用单词查询功能');
                    updateSubtitles();
                }
                
                // 2秒后隐藏状态提示
                setTimeout(() => {
                    wordDbStatus.style.opacity = '0';
                    setTimeout(() => {
                        wordDbStatus.style.display = 'none';
                    }, 500);
                }, 2000);
                
                return;
            }
            
            // 从外部JSON文件加载单词数据库（HTTP协议）
            console.log('开始加载外部单词数据库...');
            const wordDbUrl = './word_database.json';
            
            fetch(wordDbUrl)
                .then(response => {
                    console.log('收到响应:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('开始解析JSONL格式文件...');
                    
                    // 尝试解析为JSONL格式（每行一个JSON对象）
                    const lines = text.trim().split('\n');
                    const wordDatabase = {};
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        try {
                            const wordData = JSON.parse(line);
                            const word = wordData.word;
                            
                            if (word) {
                                // 转换格式以匹配我们的期望结构
                                wordDatabase[word.toLowerCase()] = {
                                    phonetic: "", // JSONL中没有音标，留空
                                    definition: wordData.translation || wordData.definition || "",
                                    tags: [] // JSONL中没有标签，留空
                                };
                            }
                        } catch (parseError) {
                            console.warn(`第${i + 1}行JSON解析失败:`, parseError.message);
                            continue;
                        }
                    }
                    
                    return wordDatabase;
                })
                .then(data => {
                    wordDatabase = data;
                    console.log('单词数据库加载完成，包含 ' + Object.keys(wordDatabase).length + ' 个单词');
                    wordDbStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #2ec4b6;"></i> 单词数据库已加载 (' + Object.keys(wordDatabase).length + ' 个单词)';
                    
                    // 在单词数据库加载完成后，重新调用updateSubtitles（如果字幕已经加载）
                    if (subtitles && subtitles.length > 0) {
                        console.log('重新更新字幕以应用单词查询功能');
                        updateSubtitles();
                    }
                    
                    // 2秒后隐藏状态提示
                    setTimeout(() => {
                        wordDbStatus.style.opacity = '0';
                        setTimeout(() => {
                            wordDbStatus.style.display = 'none';
                        }, 500);
                    }, 2000);
                })
                .catch(error => {
                    console.error('加载单词数据库失败:', error);
                    console.error('错误详情:', error.message);
                    console.error('完整错误对象:', error);
                    
                    // 根据错误类型显示不同的提示信息
                    let errorMessage = '单词数据库加载失败';
                    let detailedError = error.message;
                    
                    if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                        errorMessage = '跨域错误：请使用HTTP服务器运行（如VS Code Live Server）';
                    } else if (error.message.includes('404')) {
                        errorMessage = '找不到word_database.json文件';
                        detailedError = '请确保word_database.json文件在正确位置';
                    } else if (error.message.includes('JSON')) {
                        errorMessage = 'JSON格式错误，请检查文件格式';
                        detailedError = 'JSON文件可能包含语法错误';
                    } else if (error.message.includes('timeout')) {
                        errorMessage = '加载超时，文件可能过大';
                        detailedError = '2.8MB文件加载可能需要较长时间';
                    } else if (error.message.includes('NetworkError')) {
                        errorMessage = '网络错误，请检查网络连接';
                        detailedError = '可能是网络问题或服务器问题';
                    }
                    
                    console.log('当前URL:', window.location.href);
                    console.log('尝试加载的URL:', wordDbUrl);
                    
                    wordDbStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ff9f1c;"></i> ' + errorMessage + '<br><small>' + detailedError + '</small>';
                    
                    // 如果加载失败，使用内置的基础单词数据库作为备用
                    wordDatabase = {
                        "shadowing": {
                            phonetic: "/ˈʃædoʊɪŋ/",
                            definition: "n. 跟读法；影子练习",
                            tags: ["ielts"]
                        },
                        "academic": {
                            phonetic: "/ˌækəˈdemɪk/",
                            definition: "adj. 学术的；教学的；理论的",
                            tags: ["cet6", "postgraduate"]
                        },
                        "pronunciation": {
                            phonetic: "/prəˌnʌnsiˈeɪʃən/",
                            definition: "n. 发音；读音",
                            tags: ["cet4", "ielts"]
                        }
                    };
                    
                    // 5秒后隐藏状态提示，给用户更多时间看到错误信息
                    setTimeout(() => {
                        wordDbStatus.style.opacity = '0';
                        setTimeout(() => {
                            wordDbStatus.style.display = 'none';
                        }, 500);
                    }, 5000);
                });
        }
        
        // 全局变量，确保事件只绑定一次
        let wordClickEventBound = false;
        
        // 添加单词点击支持
        function addWordClickSupport() {
            if (wordClickEventBound) return;
            wordClickEventBound = true;
            
            // 使用事件委托，绑定到document
            document.addEventListener('click', function(e) {
                // 检查是否点击了单词元素
                if (e.target.classList.contains('word')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const word = e.target.getAttribute('data-word');
                    if (word) {
                        showWordTooltip(word, e.clientX, e.clientY);
                    }
                    return;
                }
                
                // 点击其他地方隐藏工具提示
                const tooltip = document.getElementById('wordTooltip');
                if (tooltip && !e.target.closest('#wordTooltip')) {
                    tooltip.style.display = 'none';
                }
            });
        }
        
        // 显示单词工具提示
        function showWordTooltip(word, x, y) {
            const tooltip = document.getElementById('wordTooltip');
            if (!tooltip) return;
            
            // 在showWordTooltip函数开头添加对wordDatabase是否已加载的检查
            if (Object.keys(wordDatabase).length === 0) {
                // 单词数据库还在加载中
                document.getElementById('tooltipWord').textContent = word;
                document.getElementById('tooltipPhonetic').textContent = "";
                document.getElementById('tooltipDefinition').textContent = "单词数据库正在加载中...";
                document.getElementById('tooltipTags').innerHTML = '';
                
                // 显示工具提示
                tooltip.style.display = 'block';
                tooltip.style.visibility = 'visible';
                tooltip.style.opacity = '1';
                
                // 计算位置
                setTimeout(() => {
                    const rect = tooltip.getBoundingClientRect();
                    let left = x - rect.width / 2;
                    let top = y - rect.height - 10;
                    
                    // 边界检查
                    if (left < 10) left = 10;
                    if (left + rect.width > window.innerWidth - 10) {
                        left = window.innerWidth - rect.width - 10;
                    }
                    if (top < 10) top = y + 20;
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }, 0);
                return;
            }
            
            const wordData = wordDatabase[word.toLowerCase()] || {
                definition: "未找到该单词的释义",
                phonetic: "",
                tags: []
            };
            
            // 设置内容
            document.getElementById('tooltipWord').textContent = word;
            document.getElementById('tooltipPhonetic').textContent = wordData.phonetic || "";
            document.getElementById('tooltipDefinition').textContent = wordData.definition;
            
            // 设置标签
            const tagsContainer = document.getElementById('tooltipTags');
            tagsContainer.innerHTML = '';
            
            const tagConfig = {
                "cet4": {text: "四级", class: "cet4"},
                "cet6": {text: "六级", class: "cet6"},
                "ielts": {text: "雅思", class: "ielts"},
                "postgraduate": {text: "考研", class: "postgraduate"}
            };
            
            wordData.tags.forEach(tag => {
                if (tagConfig[tag]) {
                    const tagEl = document.createElement('div');
                    tagEl.textContent = tagConfig[tag].text;
                    tagEl.className = `word-tag ${tagConfig[tag].class}`;
                    tagsContainer.appendChild(tagEl);
                }
            });
            
            // 显示工具提示
            tooltip.style.display = 'block';
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
            
            // 计算位置
            setTimeout(() => {
                const rect = tooltip.getBoundingClientRect();
                let left = x - rect.width / 2;
                let top = y - rect.height - 10;
                
                // 边界检查
                if (left < 10) left = 10;
                if (left + rect.width > window.innerWidth - 10) {
                    left = window.innerWidth - rect.width - 10;
                }
                if (top < 10) top = y + 20;
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }, 0);
        }
        
        // 渲染英文句子（拆分单词）
        function renderEnglishSentence(sentence) {
            // 拆分单词同时保留标点
            return sentence.split(/([ ,.!?;:])/).filter(Boolean).map(token => {
                if (/^[,.!?;:\s]+$/.test(token)) {
                    return token; // 标点和空格直接返回
                }
                
                // 创建可点击的单词元素
                const word = token.replace(/[^a-zA-Z'-]/g, '');
                // 只有当word不为空时才创建可点击元素
                if (word.length > 0) {
                    return `<span class="word" data-word="${word}">${token}</span>`;
                } else {
                    return token; // 如果没有有效单词，直接返回原token
                }
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('LiLi影子跟读完美版 - DOM加载完成');
            
            // 立即绑定单词点击事件
            addWordClickSupport();
            
            // 获取DOM元素
            const videoPlayer = document.getElementById('videoPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const loopBtn = document.getElementById('loopBtn');
            const subtitleBtn = document.getElementById('subtitleBtn');
            const loopCounter = document.getElementById('loopCounter');
            const subtitleContainer = document.getElementById('subtitleContainer');
            const englishSub = document.getElementById('englishSub');
            const chineseSub = document.getElementById('chineseSub');
            const statusMessage = document.getElementById('statusMessage');
            const speedBtns = document.querySelectorAll('.speed-btn');
            const progressBar = document.getElementById('progressBar');
            const videoUpload = document.getElementById('videoUpload');
            const subtitleUpload = document.getElementById('subtitleUpload');
            const videoFilename = document.getElementById('videoFilename');
            const subtitleFilename = document.getElementById('subtitleFilename');
            
            // 字幕数据（subtitles已移到全局作用域）
            let currentSubIndex = 0;
            let loopCount = 0;
            let isLooping = false;
            let subtitlesEnabled = true;
            let currentLoopStart = 0;
            let currentLoopEnd = 0;
            
            // 初始化页面
            function initializePage() {
                console.log('开始初始化页面...');
                
                // 设置初始状态
                statusMessage.textContent = "请上传视频和字幕文件开始学习";
                videoFilename.textContent = "未选择视频文件";
                subtitleFilename.textContent = "未选择字幕文件";
                
                // 初始化字幕显示
                updateSubtitles();
                
                // 添加错误处理
                videoPlayer.addEventListener('error', function(e) {
                    console.error('视频加载错误:', e);
                    statusMessage.textContent = "视频加载失败，请重新上传";
                });
                
                console.log('页面初始化完成');
                
                // 立即隐藏加载指示器，不等待单词数据库加载
                const pageLoading = document.getElementById('pageLoading');
                if (pageLoading) {
                    pageLoading.classList.add('hidden');
                }
            }
            
            // 调用初始化函数
            initializePage();
            
            // 初始化单词数据库（异步加载，不阻塞页面初始化）
            initWordDatabase();
            
            // 播放/暂停按钮事件
            playPauseBtn.addEventListener('click', function() {
                if (videoPlayer.paused) {
                    // 检查是否有视频源
                    if (!videoPlayer.src && !videoPlayer.currentSrc) {
                        statusMessage.textContent = "请先上传视频文件";
                        return;
                    }
                    
                    videoPlayer.play().then(() => {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        playPauseBtn.classList.add('btn-active');
                        statusMessage.textContent = "播放中";
                    }).catch(error => {
                        console.error('播放失败:', error);
                        statusMessage.textContent = "播放失败，请检查视频文件";
                    });
                } else {
                    videoPlayer.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    statusMessage.textContent = "已暂停";
                }
            });
            
            // 上一句按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentSubIndex > 0) {
                    currentSubIndex--;
                    jumpToSubtitle(currentSubIndex);
                    prevBtn.classList.add('btn-active');
                    setTimeout(() => prevBtn.classList.remove('btn-active'), 300);
                }
            });
            
            // 下一句按钮事件
            nextBtn.addEventListener('click', function() {
                if (currentSubIndex < subtitles.length - 1) {
                    currentSubIndex++;
                    jumpToSubtitle(currentSubIndex);
                    nextBtn.classList.add('btn-active');
                    setTimeout(() => nextBtn.classList.remove('btn-active'), 300);
                }
            });
            
            // 单句循环按钮事件
            loopBtn.addEventListener('click', function() {
                isLooping = !isLooping;
                loopBtn.classList.toggle('active', isLooping);
                
                if (isLooping) {
                    // 设置当前句子的循环起始点
                    if (subtitles.length > 0 && currentSubIndex < subtitles.length) {
                        currentLoopStart = subtitles[currentSubIndex].start;
                        currentLoopEnd = subtitles[currentSubIndex].end;
                    }
                    
                    loopBtn.classList.add('btn-active');
                    setTimeout(() => loopBtn.classList.remove('btn-active'), 300);
                    statusMessage.textContent = "单句循环已启用";
                } else {
                    statusMessage.textContent = "单句循环已禁用";
                }
            });
            
            // 字幕开关按钮事件
            subtitleBtn.addEventListener('click', function() {
                subtitlesEnabled = !subtitlesEnabled;
                subtitleBtn.classList.toggle('active', subtitlesEnabled);
                subtitleContainer.style.opacity = subtitlesEnabled ? '1' : '0';
                
                statusMessage.textContent = subtitlesEnabled ? "字幕已显示" : "字幕已隐藏";
            });
            
            // 倍速按钮事件
            speedBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const speed = parseFloat(this.dataset.speed);
                    videoPlayer.playbackRate = speed;
                    
                    speedBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    statusMessage.textContent = `播放速度: ${speed}x`;
                });
            });
            
            // 视频时间更新事件
            videoPlayer.addEventListener('timeupdate', function() {
                const currentTime = videoPlayer.currentTime;
                const duration = videoPlayer.duration;
                
                // 更新进度条
                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                }
                
                // 检查是否应该循环当前句子
                if (isLooping && subtitles.length > 0) {
                    // 如果当前时间超过当前循环句子的结束时间，则跳回开始
                    if (currentTime >= currentLoopEnd) {
                        loopCount++;
                        loopCounter.textContent = `循环: ${loopCount}`;
                        videoPlayer.currentTime = currentLoopStart;
                        statusMessage.textContent = `当前句子循环次数: ${loopCount}`;
                        return; // 避免执行后续的下一句检测
                    }
                }
                
                // 检查是否应该显示下一句字幕
                if (subtitles.length > 0 && currentSubIndex < subtitles.length - 1 && currentTime >= subtitles[currentSubIndex + 1].start) {
                    currentSubIndex++;
                    updateSubtitles();
                    
                    // 如果开启了循环，更新循环范围
                    if (isLooping) {
                        currentLoopStart = subtitles[currentSubIndex].start;
                        currentLoopEnd = subtitles[currentSubIndex].end;
                    }
                }
            });
            
            // 视频结束事件
            videoPlayer.addEventListener('ended', function() {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                statusMessage.textContent = "播放完成";
            });
            
            // 视频上传事件
            videoUpload.addEventListener('change', function(e) {
                console.log('视频文件上传事件触发');
                const file = e.target.files[0];
                if (!file) {
                    console.log('没有选择视频文件');
                    statusMessage.textContent = "未选择视频文件，请重新选择";
                    return;
                }
                
                console.log('选择的视频文件:', file.name, '大小:', file.size, '类型:', file.type);
                
                videoFilename.textContent = file.name;
                statusMessage.innerHTML = '<span class="loading"></span> 正在加载视频...';
                
                try {
                    const videoURL = URL.createObjectURL(file);
                    videoPlayer.src = videoURL;
                    videoPlayer.load();
                    
                    // 添加加载事件监听
                    videoPlayer.addEventListener('loadedmetadata', function() {
                        console.log('视频元数据加载完成');
                        statusMessage.textContent = "视频元数据加载完成";
                    });
                    
                    videoPlayer.addEventListener('loadeddata', function() {
                        console.log('视频数据加载完成');
                        statusMessage.textContent = "视频加载完成，准备播放";
                        
                        // 尝试自动播放
                        videoPlayer.play().then(() => {
                            console.log('视频自动播放成功');
                            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                            statusMessage.textContent = "视频播放中";
                        }).catch(error => {
                            console.error('自动播放失败:', error);
                            statusMessage.textContent = "视频加载完成，点击播放按钮开始播放";
                        });
                    });
                    
                } catch (error) {
                    console.error('视频处理错误:', error);
                    statusMessage.textContent = "视频处理失败，请选择其他文件";
                }
            });
            
            // 字幕上传事件
            subtitleUpload.addEventListener('change', function(e) {
                console.log('字幕文件上传事件触发');
                const file = e.target.files[0];
                if (!file) {
                    console.log('没有选择文件');
                    statusMessage.textContent = "未选择文件，请重新选择";
                    return;
                }
                
                console.log('选择的字幕文件:', file.name, '大小:', file.size, '类型:', file.type);
                
                subtitleFilename.textContent = file.name;
                statusMessage.innerHTML = '<span class="loading"></span> 正在加载字幕...';
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log('字幕文件读取完成，开始解析');
                    try {
                        const content = e.target.result;
                        console.log('文件内容长度:', content.length);
                        
                        // 解析字幕文件
                        subtitles = parseSubtitle(content);
                        currentSubIndex = 0;
                        loopCount = 0;
                        loopCounter.textContent = `循环: ${loopCount}`;
                        
                        console.log('解析到的字幕数量:', subtitles.length);
                        
                        if (subtitles.length > 0) {
                            statusMessage.textContent = `成功加载 ${subtitles.length} 条双语字幕`;
                            updateSubtitles();
                            
                            // 强制确保第一条字幕正确渲染为可点击单词
                            setTimeout(() => {
                                const englishSub = document.getElementById('englishSub');
                                if (englishSub && subtitles[0] && subtitles[0].eng) {
                                    englishSub.innerHTML = renderEnglishSentence(subtitles[0].eng);
                                }
                            }, 100);
                        } else {
                            statusMessage.textContent = "字幕文件为空或格式不正确，请检查文件内容";
                            console.log('字幕解析结果为空');
                        }
                    } catch (error) {
                        console.error('字幕解析错误:', error);
                        statusMessage.textContent = "字幕解析失败: " + error.message;
                    }
                };
                
                reader.readAsText(file);
            });
            
            // 辅助函数：跳转到指定字幕
            function jumpToSubtitle(index) {
                if (subtitles.length === 0) return;
                
                currentSubIndex = index;
                videoPlayer.currentTime = subtitles[index].start;
                loopCount = 0;
                loopCounter.textContent = `循环: ${loopCount}`;
                updateSubtitles();
                
                // 更新循环范围
                if (isLooping) {
                    currentLoopStart = subtitles[index].start;
                    currentLoopEnd = subtitles[index].end;
                }
                
                if (videoPlayer.paused) {
                    videoPlayer.play().then(() => {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    }).catch(error => {
                        console.error('跳转播放失败:', error);
                    });
                }
            }
            
            // 辅助函数：解析字幕文件
            function parseSubtitle(text) {
                console.log('开始解析字幕文件，内容长度:', text.length);
                
                const subtitles = [];
                const blocks = text.split(/\n\s*\n/);
                
                console.log('分割后的块数量:', blocks.length);
                
                for (let i = 0; i < blocks.length; i++) {
                    const block = blocks[i];
                    if (!block.trim()) continue;
                    
                    const lines = block.split('\n').map(line => line.trim()).filter(line => line !== '');
                    
                    console.log(`块 ${i + 1} 行数:`, lines.length, '内容:', lines);
                    
                    // 至少需要序号、时间轴和内容
                    if (lines.length < 3) {
                        console.log(`块 ${i + 1} 行数不足，跳过`);
                        continue;
                    }
                    
                    // 解析时间轴
                    const timeline = lines[1];
                    const timeParts = timeline.split('-->');
                    if (timeParts.length !== 2) {
                        console.log(`块 ${i + 1} 时间轴格式错误:`, timeline);
                        continue;
                    }
                    
                    const startTime = parseTime(timeParts[0].trim());
                    const endTime = parseTime(timeParts[1].trim());
                    
                    console.log(`块 ${i + 1} 时间:`, startTime, '->', endTime);
                    
                    // 内容行 - 取第2行之后的所有行
                    const contentLines = lines.slice(2);
                    
                    // 尝试分离中英文字幕
                    let eng = "";
                    let chi = "";
                    
                    // 策略1：一行中文一行英文（根据实际字幕文件格式）
                    if (contentLines.length >= 2) {
                        // 第一行是中文，第二行是英文
                        chi = contentLines[0];
                        eng = contentLines[1];
                        console.log(`块 ${i + 1} 分离结果 - 中文:`, chi, '英文:', eng);
                    } 
                    // 策略2：单行内容，尝试用括号分隔
                    else if (contentLines.length === 1) {
                        const content = contentLines[0];
                        // 尝试匹配中括号或小括号中的中文内容
                        const match = content.match(/(.*?)[（(](.+?)[)）](.*)/);
                        if (match) {
                            eng = (match[1] + match[3]).trim();
                            chi = match[2].trim();
                            console.log(`块 ${i + 1} 括号分离结果 - 英文:`, eng, '中文:', chi);
                        } else {
                            // 策略3：尝试用斜杠分隔
                            const slashMatch = content.match(/(.*?)\/(.*)/);
                            if (slashMatch) {
                                chi = slashMatch[1].trim();
                                eng = slashMatch[2].trim();
                                console.log(`块 ${i + 1} 斜杠分离结果 - 中文:`, chi, '英文:', eng);
                            } else {
                                // 策略4：尝试用破折号分隔
                                const dashMatch = content.match(/(.*?)\s*-\s*(.*)/);
                                if (dashMatch) {
                                    chi = dashMatch[1].trim();
                                    eng = dashMatch[2].trim();
                                    console.log(`块 ${i + 1} 破折号分离结果 - 中文:`, chi, '英文:', eng);
                                } else {
                                    // 无法分离，整行作为英文
                                    eng = content;
                                    chi = content;
                                    console.log(`块 ${i + 1} 无法分离，使用原内容:`, content);
                                }
                            }
                        }
                    }
                    
                    subtitles.push({
                        start: startTime,
                        end: endTime,
                        eng: eng,
                        chi: chi
                    });
                }
                
                console.log('解析完成，总字幕数:', subtitles.length);
                return subtitles;
            }
            
            // 辅助函数：转换时间格式
            function parseTime(timeStr) {
                // 支持两种格式：00:00:05,000 和 00:00:05.000
                const parts = timeStr.split(/[:,.]/);
                if (parts.length !== 4) return 0;
                
                const hours = parseInt(parts[0]);
                const minutes = parseInt(parts[1]);
                const seconds = parseInt(parts[2]);
                const milliseconds = parseInt(parts[3]);
                
                return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
            }
            
            // 更新字幕显示
            function updateSubtitles() {
                if (subtitles.length === 0) {
                    englishSub.innerHTML = "";
                    chineseSub.textContent = "";
                    return;
                }
                
                const currentSub = subtitles[currentSubIndex];
                
                // 使用拆分单词的方式渲染英文句子
                englishSub.innerHTML = renderEnglishSentence(currentSub.eng);
                chineseSub.textContent = currentSub.chi;
                
                // 确保字幕顺序正确 - 英文在上，中文在下
                englishSub.style.order = '1 !important';
                chineseSub.style.order = '2 !important';
                
                // 添加字幕动画
                englishSub.style.transform = 'scale(1.05)';
                chineseSub.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    englishSub.style.transform = 'scale(1)';
                    chineseSub.style.transform = 'scale(1)';
                }, 300);
            }
        });
    </script>
</body>
</html>